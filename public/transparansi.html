<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Transparansi Kas | Nusaka Public</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; }
        .animate-fade-in { animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../config.js"></script>
    <script src="../member/member_guard.js"></script>
    <a href="../member/dashboard.html" class="text-xs font-bold text-slate-500 hover:text-blue-600 transition">← Kembali ke Dashboard</a>
</head>
<body class="bg-slate-50 text-slate-600 min-h-screen">

    <div class="bg-white border-b border-slate-200 sticky top-0 z-50">
        <div class="max-w-3xl mx-auto px-6 py-4 flex justify-between items-center">
            <div class="flex items-center gap-2">
                <div class="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center text-white font-bold text-xs">N</div>
                <div class="text-lg font-bold text-slate-900 tracking-tight">NUSAKA<span class="text-blue-600">open</span></div>
            </div>
            <a href="../index.html" class="text-xs font-bold text-slate-500 hover:text-blue-600 transition">Login Admin →</a>
        </div>
    </div>

    <main class="max-w-3xl mx-auto p-6 pb-20 animate-fade-in">
        
        <div class="text-center py-8">
            <h1 class="text-2xl md:text-3xl font-extrabold text-slate-900 mb-2">Transparansi Keuangan</h1>
            <p class="text-slate-400 text-sm">Data keuangan ini disajikan secara realtime dan transparan.</p>
        </div>

        <div class="bg-gradient-to-br from-blue-600 to-indigo-700 rounded-[2rem] p-8 md:p-10 text-white shadow-xl shadow-blue-200 relative overflow-hidden mb-8">
            <div class="absolute top-0 right-0 w-64 h-64 bg-white rounded-full mix-blend-overlay opacity-10 blur-3xl -mr-16 -mt-16"></div>
            
            <div class="relative z-10 text-center">
                <p class="text-blue-100 text-xs font-bold uppercase tracking-widest mb-2">Total Saldo Kas Saat Ini</p>
                <h2 id="publicSaldo" class="text-4xl md:text-5xl font-black tracking-tight mb-6">Rp ...</h2>
                
                <div class="inline-flex bg-white/10 backdrop-blur-md rounded-xl p-1 border border-white/10">
                    <div class="px-6 py-2 border-r border-white/10">
                        <p class="text-[10px] text-blue-200 uppercase">Masuk (Bulan Ini)</p>
                        <p id="publicIn" class="font-bold text-lg">Rp ...</p>
                    </div>
                    <div class="px-6 py-2">
                        <p class="text-[10px] text-blue-200 uppercase">Keluar (Bulan Ini)</p>
                        <p id="publicOut" class="font-bold text-lg">Rp ...</p>
                    </div>
                </div>
            </div>
            
            <p class="text-center text-[10px] text-blue-200 mt-6 opacity-70">
                Terakhir diperbarui: <span id="lastUpdate">-</span>
            </p>
        </div>

        <div class="bg-white rounded-[2rem] border border-slate-200 shadow-sm overflow-hidden">
            <div class="p-6 border-b border-slate-50 bg-slate-50/50 flex justify-between items-center">
                <h3 class="font-bold text-slate-900">Aktivitas Terakhir</h3>
                <span class="text-[10px] bg-green-100 text-green-700 px-2 py-1 rounded font-bold">Live Data</span>
            </div>
            
            <div id="publicTxList" class="divide-y divide-slate-50">
                <div class="p-8 text-center text-slate-400 text-sm italic animate-pulse">Memuat data transaksi...</div>
            </div>
            
            <div class="p-4 text-center border-t border-slate-50">
                <p class="text-[10px] text-slate-400">
                    *Nama penyetor disamarkan sebagian demi privasi anggota.
                </p>
            </div>
        </div>

    </main>

    <script>
        // --- LOGIC PUBLIC DASHBOARD ---
        const formatRupiah = (n) => new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(n);

        async function loadPublicData() {
            // Cek Koneksi
            if (!window.supabaseClient) {
                document.getElementById('publicSaldo').innerText = "Error Config";
                return;
            }

            try {
                // 1. HITUNG SALDO (Semua Transaksi PAID - Semua Withdraw APPROVED)
                const { data: income } = await window.supabaseClient.from('transactions').select('amount').eq('status', 'PAID');
                const { data: expense } = await window.supabaseClient.from('withdrawals').select('amount').eq('status', 'APPROVED');

                const totalMasuk = income?.reduce((a, b) => a + b.amount, 0) || 0;
                const totalKeluar = expense?.reduce((a, b) => a + b.amount, 0) || 0;
                
                document.getElementById('publicSaldo').innerText = formatRupiah(totalMasuk - totalKeluar);

                // 2. HITUNG BULAN INI
                const date = new Date();
                const firstDay = new Date(date.getFullYear(), date.getMonth(), 1).toISOString();

                const { data: incomeMonth } = await window.supabaseClient.from('transactions')
                    .select('amount').eq('status', 'PAID').gte('created_at', firstDay);
                
                const { data: expenseMonth } = await window.supabaseClient.from('withdrawals')
                    .select('amount').eq('status', 'APPROVED').gte('created_at', firstDay);

                const currentIn = incomeMonth?.reduce((a, b) => a + b.amount, 0) || 0;
                const currentOut = expenseMonth?.reduce((a, b) => a + b.amount, 0) || 0;

                document.getElementById('publicIn').innerText = "+" + formatRupiah(currentIn);
                document.getElementById('publicOut').innerText = "-" + formatRupiah(currentOut);
                
                document.getElementById('lastUpdate').innerText = new Date().toLocaleString('id-ID');

                // 3. LOAD 10 TRANSAKSI TERAKHIR (GABUNGAN MASUK & KELUAR)
                // Note: Supabase agak tricky untuk UNION query, kita ambil Transaksi Masuk saja dulu untuk simpelnya
                // Atau idealnya buat View di database. Disini kita ambil "Uang Masuk" saja sebagai contoh.
                
                const { data: txList } = await window.supabaseClient
                    .from('transactions')
                    .select('amount, created_at, payment_method, profiles(full_name)')
                    .eq('status', 'PAID')
                    .order('created_at', { ascending: false })
                    .limit(7);

                const container = document.getElementById('publicTxList');
                
                if (txList && txList.length > 0) {
                    container.innerHTML = txList.map(tx => {
                        // SENSOR NAMA (Privasi)
                        // Budi Santoso -> Budi S***
                        let safeName = "Hamba Allah";
                        if (tx.profiles?.full_name) {
                            const parts = tx.profiles.full_name.split(' ');
                            safeName = parts[0] + (parts.length > 1 ? " " + parts[1][0] + "***" : "***");
                        }

                        return `
                        <div class="flex items-center justify-between p-5 hover:bg-slate-50 transition">
                            <div class="flex items-center gap-4">
                                <div class="w-10 h-10 rounded-full bg-emerald-50 text-emerald-600 flex items-center justify-center font-bold text-sm">↓</div>
                                <div>
                                    <p class="font-bold text-slate-800 text-sm">${safeName}</p>
                                    <p class="text-[11px] text-slate-400">
                                        ${new Date(tx.created_at).toLocaleDateString('id-ID', {day:'numeric', month:'short'})} • ${tx.payment_method}
                                    </p>
                                </div>
                            </div>
                            <span class="text-sm font-bold text-emerald-600">+${formatRupiah(tx.amount)}</span>
                        </div>
                        `;
                    }).join('');
                } else {
                    container.innerHTML = `<div class="p-8 text-center text-slate-400 text-sm">Belum ada data transaksi.</div>`;
                }

            } catch (err) {
                console.error(err);
            }
        }

        loadPublicData();
    </script>
</body>
</html>