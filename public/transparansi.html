<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Transparansi | Nusaka Public</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>body { font-family: 'Plus Jakarta Sans', sans-serif; }</style>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../config.js"></script>
</head>
<body class="bg-slate-50 text-slate-600 min-h-screen">

    <div class="bg-white border-b border-slate-200 sticky top-0 z-50">
        <div class="max-w-3xl mx-auto px-6 py-4 flex justify-between items-center">
            <div class="flex items-center gap-2">
                <div class="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center text-white font-bold text-xs">N</div>
                <div class="text-lg font-bold text-slate-900 tracking-tight">NUSAKA<span class="text-blue-600">open</span></div>
            </div>
            <span class="text-[10px] font-bold bg-green-100 text-green-700 px-2 py-1 rounded">LIVE DATA</span>
        </div>
    </div>

    <main class="max-w-3xl mx-auto p-6 pb-20">
        <div class="text-center py-6">
            <h1 class="text-2xl font-extrabold text-slate-900">Transparansi Keuangan</h1>
            <p class="text-slate-400 text-xs mt-1">Data real-time untuk kepercayaan bersama.</p>
        </div>

        <div class="bg-gradient-to-br from-blue-600 to-indigo-700 rounded-[2rem] p-8 text-white shadow-xl shadow-blue-200 relative overflow-hidden mb-8 text-center">
            <div class="absolute top-0 right-0 w-64 h-64 bg-white rounded-full mix-blend-overlay opacity-10 blur-3xl -mr-16 -mt-16"></div>
            <p class="text-blue-100 text-xs font-bold uppercase tracking-widest mb-2">Total Saldo Kas</p>
            <h2 id="publicSaldo" class="text-4xl md:text-5xl font-black tracking-tight mb-4">Rp ...</h2>
            <div class="text-[10px] text-blue-200 opacity-80">Update: <span id="lastUpdate">-</span></div>
        </div>

        <div class="bg-white rounded-[2rem] border border-slate-200 shadow-sm overflow-hidden">
            <div class="p-6 border-b border-slate-50 font-bold text-slate-900">Dana Masuk Terakhir</div>
            <div id="publicTxList" class="divide-y divide-slate-50">
                <div class="p-8 text-center text-slate-400 text-sm italic animate-pulse">Memuat data...</div>
            </div>
        </div>
    </main>

    <script>
        const formatRupiah = (n) => new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(n);

        async function loadData() {
            if (!window.supabaseClient) return;

            try {
                // 1. HITUNG SALDO
                const { data: inc } = await window.supabaseClient.from('transactions').select('amount').eq('status', 'PAID');
                const { data: out } = await window.supabaseClient.from('withdrawals').select('amount').eq('status', 'APPROVED');
                
                const totalIn = inc?.reduce((a, b) => a + b.amount, 0) || 0;
                const totalOut = out?.reduce((a, b) => a + b.amount, 0) || 0;
                
                document.getElementById('publicSaldo').innerText = formatRupiah(totalIn - totalOut);
                document.getElementById('lastUpdate').innerText = new Date().toLocaleTimeString('id-ID');

                // 2. RIWAYAT (Limit 10)
                const { data: txList } = await window.supabaseClient
                    .from('transactions')
                    .select('amount, created_at, payment_method, profiles(full_name)')
                    .eq('status', 'PAID')
                    .order('created_at', { ascending: false })
                    .limit(10);

                const container = document.getElementById('publicTxList');
                if (txList && txList.length > 0) {
                    container.innerHTML = txList.map(tx => {
                        let name = "Hamba Allah";
                        if (tx.profiles?.full_name) { // Sensor Nama
                            const parts = tx.profiles.full_name.split(' ');
                            name = parts[0] + (parts.length > 1 ? " " + parts[1][0] + "***" : "***");
                        }
                        return `
                        <div class="flex items-center justify-between p-5 hover:bg-slate-50">
                            <div>
                                <p class="font-bold text-slate-800 text-sm">${name}</p>
                                <p class="text-[10px] text-slate-400">${new Date(tx.created_at).toLocaleDateString('id-ID')} â€¢ ${tx.payment_method}</p>
                            </div>
                            <span class="text-sm font-bold text-emerald-600">+${formatRupiah(tx.amount)}</span>
                        </div>`;
                    }).join('');
                } else {
                    container.innerHTML = `<div class="p-6 text-center text-xs text-slate-400">Belum ada data.</div>`;
                }
            } catch (err) { console.error(err); }
        }
        loadData();
    </script>
</body>
</html>